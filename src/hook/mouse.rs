/*
============================================================================
ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (mouse.rs)
============================================================================

ã€ãƒ•ã‚¡ã‚¤ãƒ«æ¦‚è¦ã€‘
ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯æ©Ÿèƒ½ã‚’æä¾›ã—ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã™ã‚‹ã€‚
ã‚¨ãƒªã‚¢é¸æŠã®ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯æ¤œå‡ºã€
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®è¿½è·¡ã‚’å®Ÿç¾ã™ã‚‹ä¸­æ ¸ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚

ã€ä¸»è¦æ©Ÿèƒ½ã€‘
1. ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ç®¡ç†ï¼ˆinstall/uninstall_mouse_hookï¼‰
2. ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†ï¼ˆé–‹å§‹/æ›´æ–°/çµ‚äº†ã®æ¤œå‡ºã¨å‡¦ç†ï¼‰
3. ã‚¯ãƒªãƒƒã‚¯æ¤œå‡ºï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å·¦ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼‰
4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™æ›´æ–°ï¼ˆã‚«ãƒ¼ã‚½ãƒ«è¿½è·¡ï¼‰
5. é«˜é€Ÿã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼ˆ1msä»¥ä¸‹ã®å¿œç­”æ™‚é–“ï¼‰

ã€æŠ€è¡“ä»•æ§˜ã€‘
- ãƒ•ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ï¼šWH_MOUSE_LLï¼ˆä½ãƒ¬ãƒ™ãƒ«ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ï¼‰
- ç›£è¦–ç¯„å›²ï¼šã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ï¼ˆå…¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- ã‚¤ãƒ™ãƒ³ãƒˆï¼šWM_MOUSEMOVE, WM_LBUTTONDOWN, WM_LBUTTONUP
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼šunsafeæœ€é©åŒ–ã«ã‚ˆã‚‹é«˜é€Ÿå‡¦ç†
- ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ï¼šAppStateçµŒç”±ã®å®‰å…¨ãªçŠ¶æ…‹å…±æœ‰

ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘
SetWindowsHookExW â†’ low_level_mouse_proc ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ â†’ ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥åˆ¤å®š
                         â”œâ”€ WM_MOUSEMOVE â†’ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®æ›´æ–° + ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½ç½®/æç”»æ›´æ–°
                         â”‚   â”œâ”€ is_capture_mode: capturing_overlay ã®ä½ç½®ã‚’æ›´æ–°
                         â”‚   â””â”€ is_dragging: area_select_overlay ã‚’å†æç”»
                         â”œâ”€ WM_LBUTTONDOWN â†’ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ or ã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œ
                         â”‚   â”œâ”€ is_area_select_mode: ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹çŠ¶æ…‹ã«ç§»è¡Œ
                         â”‚   â””â”€ is_capture_mode: è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯é–‹å§‹ or å˜ç™ºã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œ
                         â””â”€ WM_LBUTTONUP â†’ ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
                             â””â”€ is_dragging: ã‚¨ãƒªã‚¢é¸æŠã‚’å®Œäº†ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¶ˆè²»
                         â†“
                   CallNextHookEx â†’ ä»–ã®ã‚¢ãƒ—ãƒªã¸ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¶™ç¶šï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã¯é€éï¼‰

ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘
- ç›´æ¥ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ï¼šAppState ã¸ã® unsafe ã‚¢ã‚¯ã‚»ã‚¹
- æœ€å°é™å‡¦ç†ï¼šå¿…è¦ãªå ´åˆã®ã¿çŠ¶æ…‹æ›´æ–°
- åŠ¹ç‡çš„åˆ†å²ï¼šæ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹å‡¦ç†è² è·è»½æ¸›
- ãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ï¼šMutexå›é¿ã«ã‚ˆã‚‹é«˜é€ŸåŒ–

============================================================================
*/

// å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆå¤–éƒ¨æ©Ÿèƒ½ï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
use windows::Win32::{
    Foundation::{LPARAM, LRESULT, POINT, WPARAM}, // åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿å‹
    System::{
        LibraryLoader::GetModuleHandleW, // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒãƒ³ãƒ‰ãƒ«å–å¾—
    },

    UI::{
        WindowsAndMessaging::*, // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
    },
};

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†æ§‹é€ ä½“
use crate::app_state::*;

// ã‚¨ãƒªã‚¢é¸æŠãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
use crate::area_select::*;

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç®¡ç†é–¢æ•°
use crate::overlay::*;

// ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ç®¡ç†é–¢æ•°
use crate::screen_capture::*;

// ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
pub fn install_mouse_hook() {
    unsafe {
        // ç¾åœ¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒãƒ³ãƒ‰ãƒ«ï¼ˆè­˜åˆ¥å­ï¼‰ã‚’å–å¾—
        let module_handle = GetModuleHandleW(None).unwrap_or_default();

        // ä½ãƒ¬ãƒ™ãƒ«ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ã‚’è¨­å®š
        // WH_MOUSE_LL: ä½ãƒ¬ãƒ™ãƒ«ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ï¼ˆç”»é¢å…¨ä½“ã®ãƒã‚¦ã‚¹æ“ä½œã‚’ç›£è¦–ï¼‰
        // low_level_mouse_proc: ãƒã‚¦ã‚¹æ“ä½œãŒã‚ã£ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
        let hook = SetWindowsHookExW(
            WH_MOUSE_LL,                // ãƒ•ãƒƒã‚¯ã®ç¨®é¡
            Some(low_level_mouse_proc), // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
            Some(module_handle.into()), // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒãƒ³ãƒ‰ãƒ«
            0,                          // ã‚¹ãƒ¬ãƒƒãƒ‰IDï¼ˆ0ã¯å…¨ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰
        );

        if let Ok(hook) = hook {
            let app_state = AppState::get_app_state_mut();

            app_state.mouse_hook = Some(SafeHHOOK(hook)); // AppStateæ§‹é€ ä½“ã«ãƒ•ãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿å­˜
            println!("ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
        } else {
            eprintln!("âŒ ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
    }
}

// ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ã‚’åœæ­¢ã™ã‚‹é–¢æ•°
pub fn uninstall_mouse_hook() {
    unsafe {
        let app_state = AppState::get_app_state_mut();
        if let Some(hook) = app_state.mouse_hook {
            // ãƒ•ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆç›£è¦–åœæ­¢ï¼‰
            let _ = UnhookWindowsHookEx(*hook);
            app_state.mouse_hook = None;
            println!("ãƒã‚¦ã‚¹ãƒ•ãƒƒã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ");
        }
    }
}

/*
============================================================================
ä½ãƒ¬ãƒ™ãƒ«ãƒã‚¦ã‚¹ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£é–¢æ•°
============================================================================
 ã“ã®é–¢æ•°ã¯ç”»é¢ä¸Šã§ãƒã‚¦ã‚¹æ“ä½œï¼ˆç§»å‹•ã€ã‚¯ãƒªãƒƒã‚¯ï¼‰ãŒã‚ã‚‹ãŸã³ã«
 Windowsã‹ã‚‰è‡ªå‹•çš„ã«å‘¼ã³å‡ºã•ã‚Œã‚‹æœ€ã‚‚é‡è¦ãªé–¢æ•°

 ã€AIè§£æç”¨ï¼šã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘
 WM_MOUSEMOVE: å¸¸æ™‚ â†’ åº§æ¨™æ›´æ–° + å„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®æ›´æ–°
 WM_LBUTTONDOWN: AppState.is_area_select_modeæ™‚ â†’ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ / AppState.is_capture_modeæ™‚ â†’ ã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œ
 WM_LBUTTONUP: AppState.is_draggingæ™‚ â†’ ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã€ã‚¨ãƒªã‚¢é¸æŠå®Œäº†

 ã€é‡è¦ãªæ¡ä»¶åˆ†å²ã€‘
 1. AppState.is_area_select_mode: ã‚¨ãƒªã‚¢é¸æŠãƒœã‚¿ãƒ³ã§åˆ¶å¾¡ã•ã‚Œã‚‹çŠ¶æ…‹
 2. AppState.is_dragging: WM_LBUTTONDOWNï½WM_LBUTTONUPé–“ã®çŠ¶æ…‹

 ã€åº§æ¨™ç³»ã®ä¸€è²«æ€§ã€‘
 - å…¨ã¦ã®åº§æ¨™ã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³çµ¶å¯¾åº§æ¨™ï¼ˆç”»é¢å·¦ä¸ŠãŒ0,0ï¼‰
 - DPIèªè­˜ã«ã‚ˆã‚Šæ‹¡å¤§è¨­å®šã®å½±éŸ¿ã‚’å›é¿
 - GetCursorPos()ã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
*/

unsafe extern "system" fn low_level_mouse_proc(
    ncode: i32,     // å‡¦ç†ã‚³ãƒ¼ãƒ‰ï¼ˆ0ä»¥ä¸Šãªã‚‰æ­£å¸¸ï¼‰
    wparam: WPARAM, // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ï¼ˆç§»å‹•ã€ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰
    lparam: LPARAM, // ãƒã‚¦ã‚¹ã®è©³ç´°æƒ…å ±ï¼ˆåº§æ¨™ãªã©ï¼‰
) -> LRESULT {
    unsafe {
        let app_state = AppState::get_app_state_mut();
        if ncode >= 0 {
            // ãƒã‚¦ã‚¹æƒ…å ±ã‚’å–å¾—
            // MSLLHOOKSTRUCT: ãƒã‚¦ã‚¹ã®è©³ç´°æƒ…å ±ãŒæ ¼ç´ã•ã‚ŒãŸæ§‹é€ ä½“
            let mouse_struct = lparam.0 as *const MSLLHOOKSTRUCT;
            let current_pos = if !mouse_struct.is_null() {
                (*mouse_struct).pt // ç”»é¢åº§æ¨™ã§ã®ãƒã‚¦ã‚¹ä½ç½®
            } else {
                POINT { x: 0, y: 0 } // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¼ãƒ­åº§æ¨™
            };

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«AppStateæ§‹é€ ä½“ã«ç¾åœ¨ã®ãƒã‚¦ã‚¹ä½ç½®ã‚’ä¿å­˜
            app_state.current_mouse_pos = current_pos;

            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†å²
            match wparam.0 as u32 {
                WM_MOUSEMOVE => {
                    // ===== ãƒã‚¦ã‚¹ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ =====
                    // ãƒã‚¦ã‚¹ãŒç§»å‹•ã™ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹

                    // ğŸ”§ ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä½ç½®æ›´æ–°
                    if app_state.is_capture_mode {
                        if let Some(overlay) = app_state.capturing_overlay.as_mut() {
                            overlay.set_window_pos();
                        }
                    }

                    // ã‚¨ãƒªã‚¢é¸æŠã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºä¸­ã‹ã¤ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å ´åˆ
                    let is_dragging = app_state.is_area_select_mode && app_state.is_dragging;

                    if is_dragging {
                        app_state.drag_end = current_pos;

                        // ã‚¨ãƒªã‚¢é¸æŠã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å†æç”»
                        if let Some(overlay) = app_state.area_select_overlay.as_mut() {
                            overlay.refresh_overlay();
                        }
                    }
                }
                WM_LBUTTONDOWN => {
                    let mut block_mouse_propagation = false; // ä»Šå›ã¯falseã«è¨­å®šï¼ˆä¸‹ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚‚æ¸¡ã™ï¼‰

                    // ã‚¨ãƒªã‚¢é¸æŠãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã®ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
                    let is_area_select_mode = app_state.is_area_select_mode;

                    if is_area_select_mode {
                        // å·¦ã‚¯ãƒªãƒƒã‚¯æŠ¼ä¸‹æ™‚ï¼šæ­£ç¢ºãªåº§æ¨™ã‚’è¨˜éŒ²ã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
                        app_state.drag_start = current_pos;
                        app_state.drag_end = current_pos;
                        app_state.is_dragging = true;

                        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•ç²ï¼ˆä¸‹ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æ¸¡ã•ãªã„ï¼‰
                        block_mouse_propagation = true;
                    }

                    if block_mouse_propagation {
                        return LRESULT(1); // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¶ˆè²»
                    }
                }
                WM_LBUTTONUP => {
                    // ã‚¨ãƒªã‚¢é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã®ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†
                    let (is_area_select_mode, is_dragging) =
                        (app_state.is_area_select_mode, app_state.is_dragging);

                    if is_area_select_mode && is_dragging {
                        // ã€å¤‰æ›´ã€‘å³åº§ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã›ãšã€é¸æŠã‚¨ãƒªã‚¢ã‚’ä¿å­˜
                        end_area_select_mode();
                    }
                    // ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰ä¸­ã®å·¦ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
                    else {
                        if app_state.is_capture_mode {
                            // é€£ç¶šã‚¯ãƒªãƒƒã‚¯ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ï¼†é–‹å§‹
                            if app_state.auto_clicker.is_enabled()
                                && !app_state.auto_clicker.is_running()
                            {
                                let _ = app_state.auto_clicker.start(current_pos);
                                return LRESULT(1); // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¶ˆè²»
                            }

                            // ãƒ•ã‚¡ã‚¤ãƒ«åã«é€£ç•ªã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œ
                            let _ = capture_screen_area_with_counter();

                            println!(
                                "ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œ: ãƒ•ã‚¡ã‚¤ãƒ« {}.jpg",
                                app_state.capture_file_counter - 1
                            );

                            // ã€é‡è¦ã€‘å·¦ã‚¯ãƒªãƒƒã‚¯å¾Œã‚‚ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰ã¯ç¶™ç¶šã™ã‚‹ãŒã€
                            // ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚å·¦ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¸¡ã™
                            // return LRESULT(1); // å‰Šé™¤ï¼šã‚¤ãƒ™ãƒ³ãƒˆæ¶ˆè²»ã—ãªã„
                        }
                    }
                }

                // ã€å‰Šé™¤ã€‘å³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã¯ä¸è¦ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚­ãƒ¼ã«å¤‰æ›´ï¼‰
                _ => {}
            }
        }

        // ã‚¨ãƒªã‚¢é¸æŠä¸­ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºä¸­ï¼‰ã¯ã€ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸‹ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æ¸¡ã•ãªã„
        let is_area_select_mode = app_state.is_area_select_mode;

        if is_area_select_mode
            && (wparam.0 as u32 == WM_LBUTTONDOWN || wparam.0 as u32 == WM_LBUTTONUP)
        {
            return LRESULT(1); // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¶ˆè²»
        }

        // æ¬¡ã®ãƒ•ãƒƒã‚¯ã«å‡¦ç†ã‚’æ¸¡ã™
        let mouse_hook = app_state.get_mouse_hook();
        CallNextHookEx(mouse_hook, ncode, wparam, lparam)
    }
}
